<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SeguridadService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ISO2023</a> &gt; <a href="index.source.html" class="el_package">edu.uclm.esi.iso.ISO2023.services</a> &gt; <span class="el_source">SeguridadService.java</span></div><h1>SeguridadService.java</h1><pre class="source lang-java linenums">package edu.uclm.esi.iso.ISO2023.services;

import java.io.IOException;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import java.io.ByteArrayOutputStream;

import java.util.HashMap;
import java.util.Map;

import edu.uclm.esi.iso.ISO2023.entities.User;
import edu.uclm.esi.iso.ISO2023.exceptions.*;

import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.google.zxing.BarcodeFormat;
import com.google.zxing.EncodeHintType;
import com.google.zxing.MultiFormatWriter;
import com.google.zxing.WriterException;
import com.google.zxing.client.j2se.MatrixToImageWriter;
import com.google.zxing.common.BitMatrix;
import com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;
import com.warrenstrange.googleauth.GoogleAuthenticator;
import com.warrenstrange.googleauth.GoogleAuthenticatorKey;

@Service

<span class="fc" id="L31">public class SeguridadService {</span>

	public boolean restriccionesPassword(User usuario) throws contrasenaIncorrecta {

		/* restricciones de seguridad de contraseÃ±a */

<span class="nc bnc" id="L37" title="All 2 branches missed.">		if (usuario.getPassword().length() &lt; 8)</span>
<span class="nc" id="L38">			throw new contrasenaIncorrecta(&quot;Error. La contrasena tiene que tener un minimo de 8 caracteres&quot;);</span>

<span class="nc" id="L40">		boolean seguro = false;</span>
<span class="nc" id="L41">		boolean contieneMayus = false;</span>
<span class="nc" id="L42">		boolean contieneMinus = false;</span>
<span class="nc" id="L43">		boolean contieneNumero = false;</span>
<span class="nc" id="L44">		boolean contieneCaracterRaro = false;</span>

<span class="nc bnc" id="L46" title="All 10 branches missed.">		for (int i = 0; i &lt; usuario.getPassword().length()</span>
<span class="nc" id="L47">				|| (!contieneMayus &amp;&amp; !contieneNumero &amp;&amp; !contieneCaracterRaro &amp;&amp; !contieneMinus); i++) {</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">			if (Character.isUpperCase(usuario.getPassword().charAt(i)))</span>
<span class="nc" id="L49">				contieneMayus = true;</span>

<span class="nc bnc" id="L51" title="All 2 branches missed.">			if (Character.isLowerCase(usuario.getPassword().charAt(i)))</span>
<span class="nc" id="L52">				contieneMinus = true;</span>

<span class="nc bnc" id="L54" title="All 2 branches missed.">			if (Character.isDigit(usuario.getPassword().charAt(i)))</span>
<span class="nc" id="L55">				contieneNumero = true;</span>

<span class="nc bnc" id="L57" title="All 2 branches missed.">			if (esCaracterRaro(usuario.getPassword().charAt(i)))</span>
<span class="nc" id="L58">				contieneCaracterRaro = true;</span>
		}

<span class="nc" id="L61">		lanzamientoErrores(contieneMayus, contieneMinus, contieneNumero, contieneCaracterRaro);</span>

<span class="nc bnc" id="L63" title="All 8 branches missed.">		if (contieneMayus &amp;&amp; contieneMinus &amp;&amp; contieneNumero &amp;&amp; contieneCaracterRaro</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">				&amp;&amp; usuario.getPassword().length() &gt;= 8)</span>
<span class="nc" id="L65">			seguro = true;</span>
<span class="nc" id="L66">		return seguro;</span>
	}
	
	public boolean passwordSecure(String pwd) throws contrasenaIncorrecta {
<span class="nc bnc" id="L70" title="All 2 branches missed.">		if (pwd.length() &lt; 8)</span>
<span class="nc" id="L71">			throw new contrasenaIncorrecta(&quot;Error. La contrasena tiene que tener un minimo de 8 caracteres&quot;);</span>

<span class="nc" id="L73">		boolean seguro = false;</span>
<span class="nc" id="L74">		boolean contieneMayus = false;</span>
<span class="nc" id="L75">		boolean contieneMinus = false;</span>
<span class="nc" id="L76">		boolean contieneNumero = false;</span>
<span class="nc" id="L77">		boolean contieneCaracterRaro = false;</span>

<span class="nc bnc" id="L79" title="All 10 branches missed.">		for (int i = 0; i &lt; pwd.length()</span>
<span class="nc" id="L80">				|| (!contieneMayus &amp;&amp; !contieneNumero &amp;&amp; !contieneCaracterRaro &amp;&amp; !contieneMinus); i++) {</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">			if (Character.isUpperCase(pwd.charAt(i)))</span>
<span class="nc" id="L82">				contieneMayus = true;</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">			if (Character.isLowerCase(pwd.charAt(i)))</span>
<span class="nc" id="L85">				contieneMinus = true;</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">			if (Character.isDigit(pwd.charAt(i)))</span>
<span class="nc" id="L88">				contieneNumero = true;</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">			if (esCaracterRaro(pwd.charAt(i)))</span>
<span class="nc" id="L91">				contieneCaracterRaro = true;</span>
		}

<span class="nc" id="L94">		lanzamientoErrores(contieneMayus, contieneMinus, contieneNumero, contieneCaracterRaro);</span>

<span class="nc bnc" id="L96" title="All 10 branches missed.">		if (contieneMayus &amp;&amp; contieneMinus &amp;&amp; contieneNumero &amp;&amp; contieneCaracterRaro &amp;&amp; pwd.length() &gt;= 8)</span>
<span class="nc" id="L97">			seguro = true;</span>
<span class="nc" id="L98">		return seguro;</span>
	}


	public void lanzamientoErrores(boolean may, boolean min, boolean num, boolean car) throws contrasenaIncorrecta {
<span class="nc bnc" id="L103" title="All 2 branches missed.">		if (!may)</span>
<span class="nc" id="L104">			throw new contrasenaIncorrecta(&quot;Error. La contrasena tiene que tener minimo una mayuscula&quot;);</span>

<span class="nc bnc" id="L106" title="All 2 branches missed.">		if (!min)</span>
<span class="nc" id="L107">			throw new contrasenaIncorrecta(&quot;Error. La contrasena tiene que tener minimo una minusccula&quot;);</span>

<span class="nc bnc" id="L109" title="All 2 branches missed.">		if (!num)</span>
<span class="nc" id="L110">			throw new contrasenaIncorrecta(&quot;Error. La contrasena tiene que tener minimo un numero&quot;);</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (!car)</span>
<span class="nc" id="L113">			throw new contrasenaIncorrecta(&quot;Error. La contrasena tiene que tener minimo un caracter raro&quot;);</span>
<span class="nc" id="L114">	}</span>

	public static boolean esCaracterRaro(char c) {
		// Patrón que coincide con cualquier carácter que no sea una letra, un número o
		// un carácter de espacio.
<span class="nc" id="L119">		Pattern patron = Pattern.compile(&quot;[^A-Za-z0-9\\s]&quot;);</span>
<span class="nc" id="L120">		Matcher matcher = patron.matcher(String.valueOf(c));</span>
<span class="nc" id="L121">		return matcher.matches();</span>
	}

	public Boolean comprobarDni(String dni) throws numeroInvalido {

		// El DNI debe tener 9 caracteres
<span class="nc bnc" id="L127" title="All 2 branches missed.">		if (dni.length() != 9)</span>
<span class="nc" id="L128">			throw new numeroInvalido(&quot;El numero de dni introducido no es valido. Introduzca nueve digitos&quot;);</span>

		// Comprobar que los primeros 8 caracteres son dígitos
<span class="nc bnc" id="L131" title="All 2 branches missed.">		for (int i = 0; i &lt; 8; i++) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (!Character.isDigit(dni.charAt(i))) {</span>

<span class="nc" id="L134">				throw new numeroInvalido(</span>
						&quot;El numero de dni introducido no es valido. Los 8 primeros digitos deben ser numeros&quot;);

			}
		}

		// Comprobar que el último carácter es una letra
<span class="nc" id="L141">		char letra = dni.charAt(8);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (!Character.isLetter(letra)) {</span>

<span class="nc" id="L144">			throw new numeroInvalido(</span>
					&quot;El nÃºmero de dni introducido no es vÃ¡lido. El ultimo caracter debe ser una letra.&quot;);

		}

<span class="nc" id="L149">		return true;</span>
	}

	public Boolean comprobarNumero(String telefono) throws numeroInvalido {
<span class="nc bnc" id="L153" title="All 2 branches missed.">		if (telefono.length() != 9)</span>
<span class="nc" id="L154">			throw new numeroInvalido(&quot;El numero de telefono introducido no es valido. Introduzca nueve digitos&quot;);</span>

		// Evitar letras en el numero
<span class="nc bnc" id="L157" title="All 2 branches missed.">		for (int i = 0; i &lt; telefono.length(); i++) {</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">			if (!Character.isDigit(telefono.charAt(i)))</span>
<span class="nc" id="L159">				throw new numeroInvalido(&quot;El numero de telefono introducido no es valido. Introduzca nueve digitos&quot;);</span>

		}
<span class="nc" id="L162">		return true;</span>
	}

	public boolean validarEmail(String email) {
<span class="fc" id="L166">		String regex = &quot;^[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,6}$&quot;;</span>
<span class="fc" id="L167">		return email.toLowerCase().matches(regex.toLowerCase());</span>
	}

	public String cifrarPassword(String password) {
<span class="nc" id="L171">		PasswordEncoder ncoder = codificador();</span>
<span class="nc" id="L172">		return ncoder.encode(password);</span>
	}

	public PasswordEncoder codificador() {
<span class="fc" id="L176">		return new BCryptPasswordEncoder();</span>
	}

	public boolean decodificador(String password, String passwordMongo) {
<span class="fc" id="L180">		PasswordEncoder ncoder = codificador();</span>
<span class="fc" id="L181">		return ncoder.matches(password, passwordMongo);</span>
	}

	// metodos encargados del doble factor de autentificación
<span class="fc" id="L185">	private final GoogleAuthenticator gAuth = new GoogleAuthenticator();</span>

	public String generateSecretKey() {
<span class="nc" id="L188">		final GoogleAuthenticatorKey key = gAuth.createCredentials();</span>
<span class="nc" id="L189">		return key.getKey();</span>
	}

	public byte[] generateQRCodeImage(String secretKey, String username) throws WriterException, IOException {
<span class="nc" id="L193">		String otpAuthURL = getOtpAuthURL(&quot;YourIssuer&quot;, username, secretKey);</span>
<span class="nc" id="L194">		return generateQRCode(otpAuthURL, 200);</span>
	}

	private String getOtpAuthURL(String issuer, String accountName, String secretKey) {
<span class="nc" id="L198">		return String.format(&quot;otpauth://totp/%s:%s?secret=%s&amp;issuer=%s&quot;, issuer, accountName, secretKey, issuer);</span>
	}

	private byte[] generateQRCode(String text, int height) throws WriterException, IOException {
<span class="nc" id="L202">		Map&lt;EncodeHintType, ErrorCorrectionLevel&gt; hintMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L203">		hintMap.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.L);</span>

<span class="nc" id="L205">		BitMatrix bitMatrix = new MultiFormatWriter().encode(text, BarcodeFormat.QR_CODE, 200, 200, hintMap);</span>

<span class="nc" id="L207">		ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span>
<span class="nc" id="L208">		MatrixToImageWriter.writeToStream(bitMatrix, &quot;PNG&quot;, outputStream);</span>
<span class="nc" id="L209">		return outputStream.toByteArray();</span>
	}

	public boolean verifyCode(String secretKey, int code) {
<span class="nc" id="L213">		return gAuth.authorize(secretKey, code);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>